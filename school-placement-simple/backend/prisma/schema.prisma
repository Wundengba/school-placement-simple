// This is your Prisma schema file.
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  // Optimize for serverless environments
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // For Vercel serverless: ensure your DATABASE_URL includes ?pgBouncer=true or uses pooler endpoint
  // Example: postgresql://user:password@pooler.neon.tech/dbname?sslmode=require
}

model Student {
  id                String      @id @default(cuid())
  indexNumber       String      @unique
  fullName          String
  email             String?
  gender            String?     // 'male', 'female', 'other'
  dateOfBirth       DateTime?
  photo             String?     // Base64 encoded photo or URL
  maths             Int?        @db.SmallInt
  english           Int?        @db.SmallInt
  science           Int?        @db.SmallInt
  schoolPreferences SchoolPref[]
  placedSchoolId    String?
  placedSchool      School?     @relation("PlacedStudents", fields: [placedSchoolId], references: [id])
  guardianName      String?
  guardianPhone     String?
  status            String      @default("pending") // 'pending', 'placed', 'rejected'
  placements        Placement[]
  mockScores        MockScore[]
  deleted           Boolean     @default(false)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([indexNumber])
  @@index([status])
  @@index([deleted])
}

model School {
  id              String        @id @default(cuid())
  name            String        @unique
  externalId      String?       @unique
  type            String        // 'Federal', 'State', 'Private'
  location        String?
  category        String?       // 'A', 'B', 'C' for school placement categories
  capacity        Int
  enrolledCount   Int           @default(0)
  streams         Stream[]
  contactPhone    String?
  contactEmail    String?
  website         String?
  schoolPrefs     SchoolPref[]
  placements      Placement[]
  placedStudents  Student[]     @relation("PlacedStudents")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([externalId])
  @@index([type])
  @@index([category])
}

model SchoolPref {
  id        String   @id @default(cuid())
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schoolId  String
  choice    Int      // 1, 2, 3, 4 for choice order
  createdAt DateTime @default(now())

  @@unique([studentId, schoolId]) // One preference per student-school pair
  @@index([studentId])
  @@index([schoolId])
}

model Placement {
  id            String   @id @default(cuid())
  student       Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId     String
  school        School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schoolId      String
  choice        Int
  score         Float?
  status        String   @default("pending") // 'placed', 'rejected', 'pending'
  placementDate DateTime @default(now())
  algorithm     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([studentId, schoolId]) // One placement result per student-school pair
  @@index([studentId])
  @@index([schoolId])
  @@index([status])
}

model Stream {
  id       String @id @default(cuid())
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  schoolId String
  name     String
  capacity Int

  @@index([schoolId])
}

model Mock {
  id          String      @id @default(cuid())
  title       String      // e.g., "Mock Exam 1", "Practice Test January"
  description String?
  subjects    MockScore[]
  createdBy   String?     // admin username
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([isActive])
  @@index([createdAt])
}

model MockScore {
  id        String   @id @default(cuid())
  mock      Mock     @relation(fields: [mockId], references: [id], onDelete: Cascade)
  mockId    String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String
  subject   String   // 'Mathematics', 'English', 'Science', 'Literature', 'History', 'Geography', etc.
  score     Int      @db.SmallInt // 0-100
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([mockId, studentId, subject]) // One score per student per subject per mock
  @@index([mockId])
  @@index([studentId])
}

model Admin {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  email     String?
  fullName  String?
  role      String   @default("admin") // 'admin', 'moderator'
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([username])
  @@index([isActive])
}

model ActivityLog {
  id           String   @id @default(cuid())
  userId       String?
  username     String?
  action       String
  entityType   String?
  entityId     String?
  entityName   String?
  changes      Json?
  ipAddress    String?
  userAgent    String?
  description  String?
  status       String   @default("SUCCESS")
  errorMessage String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([entityType])
  @@index([entityId])
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String   @unique
  password  String
  role      String   @default("staff")
  fullName  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([username])
  @@index([email])
}
